version: "3.9"

# ==========================
#  СЕТИ
# ==========================
networks:
  spk_front:
    driver: bridge
  spk_back:
    driver: bridge
  spk_dmz:
    driver: bridge
  spk_monitoring:
    driver: bridge

# ==========================
#  VOLUMES (ДАННЫЕ)
# ==========================
volumes:
  postgres_data:
  postgres_backups:
  redis_data:
  traefik_letsencrypt:
  backend_static:
  frontend_build:
  portainer_data:
  pgadmin_data:
  minio_data:
  rabbitmq_data:
  grafana_data:
  loki_data:
  adminer_data:
  mail_data:

# ==========================
#  СЕРВИСЫ
# ==========================
services:

  # ========================
  #  Reverse-proxy + HTTPS
  # ========================
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: always
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.le.acme.tlschallenge=true"
      - "--certificatesresolvers.le.acme.email=${TRAEFIK_EMAIL}"
      - "--certificatesresolvers.le.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - traefik_letsencrypt:/letsencrypt
    networks:
      - spk_front
      - spk_dmz
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`${TRAEFIK_DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=le"
      - "traefik.http.routers.traefik.service=api@internal"

  # ========================
  #  PostgreSQL (основная БД)
  # ========================
  db:
    image: postgres:15
    container_name: spk_db
    restart: always
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_backups:/backups
    networks:
      - spk_back

  # ========================
  #  Redis (кэш / фоновые задачи)
  # ========================
  redis:
    image: redis:7
    container_name: spk_redis
    restart: always
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data
    networks:
      - spk_back

  # ========================
  #  BACKEND (FastAPI / Django / др.)
  # ========================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: spk_backend
    restart: always
    env_file:
      - .env
    depends_on:
      - db
      - redis
    networks:
      - spk_back
      - spk_front
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${BACKEND_DOMAIN}`)"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=le"
      - "traefik.http.services.backend.loadbalancer.server.port=8000"

  # ========================
  #  FRONTEND (React / Vue)
  # ========================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: spk_frontend
    restart: always
    env_file:
      - .env
    depends_on:
      - backend
    networks:
      - spk_front
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${FRONTEND_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=le"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"

  # ========================
  #  Portainer (GUI для Docker)
  # ========================
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: always
    command: -H unix:///var/run/docker.sock
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - portainer_data:/data
    networks:
      - spk_dmz
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`${PORTAINER_DOMAIN}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=le"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # ========================
  #  PgAdmin (GUI к PostgreSQL)
  # ========================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: pgadmin
    restart: always
    env_file:
      - .env
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db
    networks:
      - spk_dmz
      - spk_back
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pgadmin.rule=Host(`${PGADMIN_DOMAIN}`)"
      - "traefik.http.routers.pgadmin.entrypoints=websecure"
      - "traefik.http.routers.pgadmin.tls.certresolver=le"
      - "traefik.http.services.pgadmin.loadbalancer.server.port=80"

  # ========================
  #  Adminer (ещё один DB GUI)
  # ========================
  adminer:
    image: adminer:latest
    container_name: adminer
    restart: always
    depends_on:
      - db
    networks:
      - spk_dmz
      - spk_back
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.adminer.rule=Host(`${ADMINER_DOMAIN}`)"
      - "traefik.http.routers.adminer.entrypoints=websecure"
      - "traefik.http.routers.adminer.tls.certresolver=le"
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # ========================
  #  MinIO (облачное хранилище S3)
  # ========================
  minio:
    image: minio/minio:latest
    container_name: minio
    restart: always
    env_file:
      - .env
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - spk_back
      - spk_dmz
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.minio-api.rule=Host(`${MINIO_API_DOMAIN}`)"
      - "traefik.http.routers.minio-api.entrypoints=websecure"
      - "traefik.http.routers.minio-api.tls.certresolver=le"
      - "traefik.http.services.minio-api.loadbalancer.server.port=9000"
      - "traefik.http.routers.minio-console.rule=Host(`${MINIO_CONSOLE_DOMAIN}`)"
      - "traefik.http.routers.minio-console.entrypoints=websecure"
      - "traefik.http.routers.minio-console.tls.certresolver=le"
      - "traefik.http.services.minio-console.loadbalancer.server.port=9001"

  # ========================
  #  RabbitMQ (очереди задач)
  # ========================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    restart: always
    env_file:
      - .env
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - spk_back
      - spk_dmz
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq.rule=Host(`${RABBITMQ_DOMAIN}`)"
      - "traefik.http.routers.rabbitmq.entrypoints=websecure"
      - "traefik.http.routers.rabbitmq.tls.certresolver=le"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"

  # ========================
  #  Loki + Grafana (логи + дашборды)
  # ========================
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    restart: always
    command: ["-config.file=/etc/loki/local-config.yaml"]
    volumes:
      - loki_data:/loki
    networks:
      - spk_monitoring

  grafana:
    image: grafana/grafana:10.4.2
    container_name: grafana
    restart: always
    env_file:
      - .env
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    depends_on:
      - loki
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - spk_monitoring
      - spk_dmz
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`${GRAFANA_DOMAIN}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls.certresolver=le"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"

  # ========================
  #  Простая SMTP-почта (Postfix)
  # ========================
  mail:
    image: boky/postfix
    container_name: spk_mail
    restart: always
    env_file:
      - .env
    environment:
      - MAIL_DOMAIN=${MAIL_DOMAIN}
      - SMTP_USER=${MAIL_USER}
      - SMTP_PASSWORD=${MAIL_PASSWORD}
    volumes:
      - mail_data:/var/spool/postfix
    networks:
      - spk_back
      - spk_dmz

  # ========================
  #  Бэкап БД (cron-контейнер)
  # ========================
  db_backup:
    image: postgres:15
    container_name: spk_db_backup
    restart: always
    env_file:
      - .env
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - PGPASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_backups:/backups
    command: >
      bash -c "
      while true; do
        pg_dump -h db -U ${POSTGRES_USER} ${POSTGRES_DB} > /backups/backup_$(date +%Y%m%d_%H%M%S).sql;
        sleep 86400;
      done"
    depends_on:
      - db
    networks:
      - spk_back

  # ========================
  #  Watchtower (авто-обновление образов)
  # ========================
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    command: --cleanup --interval 3600
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - spk_dmz

  # ========================
  #  Autoheal (перезапуск упавших контейнеров)
  # ========================
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    restart: always
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal=true
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=60
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - spk_dmz

